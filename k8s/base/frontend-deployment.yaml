# =============================================================================
# PyBase Frontend Deployment
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pybase-frontend
  namespace: pybase
  labels:
    app.kubernetes.io/name: pybase
    app.kubernetes.io/component: frontend
    app.kubernetes.io/part-of: pybase
    app.kubernetes.io/managed-by: kubectl
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: pybase
      app.kubernetes.io/component: frontend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: pybase
        app.kubernetes.io/component: frontend
      annotations:
        prometheus.io/scrape: "false"
    spec:
      # ==========================================================================
      # ServiceAccount for pod identity
      # ==========================================================================
      serviceAccountName: pybase-frontend
      automountServiceAccountToken: false

      # ==========================================================================
      # Main frontend container - nginx serving static React files
      # ==========================================================================
      containers:
        - name: frontend
          image: pybase-frontend:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          # ==========================================================================
          # Health checks using the /health endpoint configured in nginx.conf
          # ==========================================================================
          livenessProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 18

      # ==========================================================================
      # Pod configuration
      # ==========================================================================
      restartPolicy: Always
      # Ensure frontend pods are distributed across nodes for HA
      # Note: In production, uncomment and configure Pod anti-affinity
      # affinity:
      #   podAntiAffinity:
      #     preferredDuringSchedulingIgnoredDuringExecution:
      #       - weight: 100
      #         podAffinityTerm:
      #           labelSelector:
      #             matchExpressions:
      #               - key: app.kubernetes.io/name
      #                 operator: In
      #                 values:
      #                   - pybase
      #               - key: app.kubernetes.io/component
      #                 operator: In
      #                 values:
      #                   - frontend
      #           topologyKey: kubernetes.io/hostname

# =============================================================================
# Notes
# =============================================================================
#
# Deployment Strategy:
# - RollingUpdate with maxSurge=1, maxUnavailable=0 ensures zero-downtime updates
# - No init containers needed (static files are baked into the image)
# - Startup probe gives pods 90 seconds (18 * 5) to start serving traffic
#
# Health Checks:
# - Liveness: Detects and restarts hung containers (30s initial delay)
# - Readiness: Removes pods from service load balancing if unhealthy (10s initial delay)
# - Startup: Gives pods time to start nginx before failing liveness checks
# - All probes use the /health endpoint configured in nginx.conf
#
# Resource Limits:
# - Requests: Guaranteed CPU/memory for scheduling (50m CPU, 64Mi RAM)
# - Limits: Maximum CPU/memory a pod can use (200m CPU, 128Mi RAM)
# - Static file serving is lightweight, so limits are much lower than API/workers
#
# Container Configuration:
# - Image: pybase-frontend:latest (built from frontend/Dockerfile)
# - Port: 8080 (nginx serving static files)
# - Non-root user: nginx-user (uid/gid 1000) for security
# - Health endpoint: /health returns "healthy\n" (configured in nginx.conf)
# - Static files served from: /usr/share/nginx/html (built React app)
#
# Service Dependencies:
# - No direct dependencies on other services
# - Frontend makes API calls to backend via service discovery or ingress
# - API endpoint configuration typically done via environment variables at build time
#
# Monitoring:
# - Prometheus scraping disabled (prometheus.io/scrape: "false")
# - Static file servers don't expose application metrics
# - Monitoring focuses on uptime and response times via ingress/controller metrics
#
# =============================================================================
