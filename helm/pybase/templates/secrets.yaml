# =============================================================================
# PyBase API Secrets
# =============================================================================
# Sensitive environment variables for the PyBase FastAPI backend
# These values should be overridden in a secure values file or passed via --set
# =============================================================================
{{- if or .Values.pybase.secretKey .Values.pybase.externalServices.databaseUrl .Values.pybase.externalServices.redisUrl .Values.pybase.externalServices.s3.enabled .Values.pybase.externalServices.meilisearch.apiKey .Values.pybase.extras.werk24ApiKey .Values.pybase.extras.sentryDsn .Values.pybase.smtp.password }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "pybase.fullname" . }}-secret
  namespace: {{ include "pybase.namespace" . }}
  labels:
    {{- include "pybase.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
type: Opaque
data:
  {{- if .Values.pybase.secretKey }}
  # ==========================================================================
  # Authentication Secrets
  # ==========================================================================
  # JWT signing key (generate with: openssl rand -hex 32)
  SECRET_KEY: {{ .Values.pybase.secretKey | b64enc | quote }}
  {{- end }}

  {{- if .Values.pybase.externalServices.databaseUrl }}
  # ==========================================================================
  # Database Connection
  # ==========================================================================
  # Full PostgreSQL connection string with credentials
  # Format: postgresql+asyncpg://user:password@host:port/database
  DATABASE_URL: {{ .Values.pybase.externalServices.databaseUrl | b64enc | quote }}
  {{- else if .Values.postgresql.enabled }}
  # Built-in PostgreSQL connection string
  # Password is loaded from secret, so we use a placeholder here
  # The actual password will be injected by the application from the secret
  DATABASE_URL: {{ printf "postgresql+asyncpg://%s:PLACEHOLDER@%s-postgres:%d/%s" .Values.postgresql.username (include "pybase.fullname" .) .Values.postgresql.port .Values.postgresql.database | b64enc | quote }}
  {{- end }}

  {{- if .Values.pybase.externalServices.redisUrl }}
  # ==========================================================================
  # Redis Connection
  # ==========================================================================
  # Full Redis connection string with password
  # Format: redis://[:password@]host:port/db
  REDIS_URL: {{ .Values.pybase.externalServices.redisUrl | b64enc | quote }}
  {{- else if .Values.redis.enabled }}
  # Built-in Redis connection string (no password for simplicity)
  REDIS_URL: {{ printf "redis://%s-redis:6379/0" (include "pybase.fullname" .) | b64enc | quote }}
  {{- end }}

  {{- if not .Values.pybase.externalServices.s3.enabled }}
  {{- if .Values.minio.enabled }}
  # ==========================================================================
  # MinIO/S3 Object Storage
  # ==========================================================================
  # S3-compatible storage credentials for built-in MinIO
  # These are loaded from secrets
  S3_ENDPOINT: {{ printf "http://%s-minio:%d" (include "pybase.fullname" .) .Values.minio.apiPort | b64enc | quote }}
  S3_BUCKET: {{ .Values.minio.defaultBucket.name | b64enc | quote }}
  {{- end }}
  {{- end }}

  {{- if or (and .Values.pybase.externalServices.s3.enabled .Values.pybase.externalServices.s3.endpoint) (and .Values.minio.enabled) }}
  # ==========================================================================
  # S3 Configuration (External or Built-in)
  # ==========================================================================
  {{- if and .Values.pybase.externalServices.s3.enabled .Values.pybase.externalServices.s3.endpoint }}
  S3_ENDPOINT: {{ .Values.pybase.externalServices.s3.endpoint | b64enc | quote }}
  {{- end }}
  {{- if and .Values.pybase.externalServices.s3.enabled .Values.pybase.externalServices.s3.accessKey }}
  S3_ACCESS_KEY: {{ .Values.pybase.externalServices.s3.accessKey | b64enc | quote }}
  {{- end }}
  {{- if and .Values.pybase.externalServices.s3.enabled .Values.pybase.externalServices.s3.secretKey }}
  S3_SECRET_KEY: {{ .Values.pybase.externalServices.s3.secretKey | b64enc | quote }}
  {{- end }}
  {{- if and .Values.pybase.externalServices.s3.enabled .Values.pybase.externalServices.s3.bucket }}
  S3_BUCKET: {{ .Values.pybase.externalServices.s3.bucket | b64enc | quote }}
  {{- end }}
  {{- end }}

  {{- if .Values.pybase.externalServices.meilisearch.apiKey }}
  # ==========================================================================
  # Meilisearch Authentication
  # ==========================================================================
  # Meilisearch master key (if authentication enabled)
  MEILISEARCH_API_KEY: {{ .Values.pybase.externalServices.meilisearch.apiKey | b64enc | quote }}
  {{- else if .Values.meilisearch.enabled }}
  # Built-in Meilisearch URL
  MEILISEARCH_URL: {{ printf "http://%s-meilisearch:%d" (include "pybase.fullname" .) .Values.meilisearch.port | b64enc | quote }}
  {{- end }}

  {{- if .Values.pybase.extras.werk24ApiKey }}
  # ==========================================================================
  # External Services (Optional)
  # ==========================================================================
  # Werk24 API key for engineering drawing AI extraction
  WERK24_API_KEY: {{ .Values.pybase.extras.werk24ApiKey | b64enc | quote }}
  {{- end }}

  {{- if .Values.pybase.extras.sentryDsn }}
  # Sentry error tracking DSN (optional)
  SENTRY_DSN: {{ .Values.pybase.extras.sentryDsn | b64enc | quote }}
  {{- end }}

  {{- if .Values.pybase.smtp.password }}
  # ==========================================================================
  # Email Authentication (Optional)
  # ==========================================================================
  # SMTP authentication password
  SMTP_PASSWORD: {{ .Values.pybase.smtp.password | b64enc | quote }}
  {{- end }}
{{- end }}

# =============================================================================
# Important Security Notes
# =============================================================================
#
# 1. NEVER commit actual secret values to version control
# 2. Use Helm secrets or external secret management (e.g., Vault, Sealed Secrets)
# 3. Override these values using:
#    - helm install -f secret-values.yaml
#    - helm install --set pybase.secretKey=xxx
#    - Environment variables in CI/CD
#
# 4. Generate secure secrets:
#    - JWT Secret: openssl rand -hex 32
#    - PostgreSQL Password: openssl rand -base64 32
#    - Redis Password: openssl rand -base64 32
#    - MinIO Credentials: openssl rand -base64 32
#    - Meilisearch Master Key: openssl rand -base64 32
#
# 5. Example secret-values.yaml:
#    pybase:
#      secretKey: "your-generated-jwt-key"
#      extras:
#        werk24ApiKey: "your-werk24-api-key"
#        sentryDsn: "your-sentry-dsn"
#      smtp:
#        password: "your-smtp-password"
#    minio:
#      rootUser: "minio-admin"
#      rootPassword: "minio-secret-key"
#    meilisearch:
#      env:
#        MEILI_MASTER_KEY: "meilisearch-master-key"
#
# =============================================================================

{{- if .Values.postgresql.enabled }}
# =============================================================================
# PostgreSQL Secret for PyBase
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "pybase.fullname" . }}-postgres-secret
  namespace: {{ include "pybase.namespace" . }}
  labels:
    {{- include "pybase.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgres
type: Opaque
data:
  # PostgreSQL password (generate with: openssl rand -base64 32)
  # If .Values.postgresql.password is set, use it; otherwise use default
  {{- if .Values.postgresql.password }}
  password: {{ .Values.postgresql.password | b64enc | quote }}
  {{- else }}
  password: {{ "change-me-in-production" | b64enc | quote }}
  {{- end }}
{{- end }}

{{- if .Values.minio.enabled }}
# =============================================================================
# MinIO Secret for PyBase
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "pybase.fullname" . }}-minio-secret
  namespace: {{ include "pybase.namespace" . }}
  labels:
    {{- include "pybase.labels" . | nindent 4 }}
    app.kubernetes.io/component: minio
type: Opaque
data:
  # MinIO root user (access key)
  {{- if .Values.minio.rootUser }}
  root-user: {{ .Values.minio.rootUser | b64enc | quote }}
  {{- else }}
  root-user: {{ "minioadmin" | b64enc | quote }}
  {{- end }}
  # MinIO root password (generate with: openssl rand -base64 32)
  {{- if .Values.minio.rootPassword }}
  root-password: {{ .Values.minio.rootPassword | b64enc | quote }}
  {{- else }}
  root-password: {{ "change-me-in-production" | b64enc | quote }}
  {{- end }}
{{- end }}

